<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ssh 使用 | 哎! 就是玩~</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="
SSH（Secure Shell 的缩写）是一种网络协议，用于加密两台计算机之间的通信，并且支持各种身份验证机制。它主要用于保证远程登录和远程通信的安全，任何网络服务都可以用这个协议来加密。
网络主机之间的通信是不加密的，属于明文通信。这使得通信很不安全，一个典型的例子就是服务器登录。登录远程服务器的时候，需要将用户输入的密码传给服务器，如果这个过程是明文通信，就意味着传递过程中，线路经 ...">
    
    <link rel="preload" href="/assets/css/0.styles.59a41dfe.css" as="style"><link rel="preload" href="/assets/js/app.a5a1f001.js" as="script"><link rel="preload" href="/assets/js/6.e4377708.js" as="script"><link rel="preload" href="/assets/js/3.97575248.js" as="script"><link rel="preload" href="/assets/js/14.9188933b.js" as="script"><link rel="prefetch" href="/assets/js/10.e7ac7f61.js"><link rel="prefetch" href="/assets/js/11.0ae09f89.js"><link rel="prefetch" href="/assets/js/12.e2ea5c1c.js"><link rel="prefetch" href="/assets/js/13.8461bad6.js"><link rel="prefetch" href="/assets/js/4.375976eb.js"><link rel="prefetch" href="/assets/js/5.31510287.js"><link rel="prefetch" href="/assets/js/7.4fe554d4.js"><link rel="prefetch" href="/assets/js/8.cdb62f07.js"><link rel="prefetch" href="/assets/js/9.c178b71a.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.5d3d092e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.59a41dfe.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">哎! 就是玩~ </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">哎! 就是玩~ </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        ssh 使用
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">scl</span> <span itemprop="address">   in WH</span></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2021-04-21T00:00:00.000Z">
      Wed Apr 21 2021
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/tag/ssh" data-v-42ccfcd5><span data-v-42ccfcd5>ssh</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h2 id="ssh-介绍"><a href="#ssh-介绍" class="header-anchor">#</a> SSH 介绍</h2> <p>SSH（Secure Shell 的缩写）是一种网络协议，用于加密两台计算机之间的通信，并且支持各种身份验证机制。它主要用于保证远程登录和远程通信的安全，任何网络服务都可以用这个协议来加密。</p> <p>网络主机之间的通信是不加密的，属于明文通信。这使得通信很不安全，一个典型的例子就是服务器登录。登录远程服务器的时候，需要将用户输入的密码传给服务器，如果这个过程是明文通信，就意味着传递过程中，线路经过的中间计算机都能看到密码，这是很可怕的。
SSH 就是为了解决这个问题而诞生的，它能够加密计算机之间的通信，保证不被窃听或篡改。它还能对操作者进行认证（authentication）和授权（authorization）。明文的网络协议可以套用在它里面，从而实现加密。</p> <p>SSH之所以能够保证安全，原因在于它采用了公钥加密。
整个过程是这样的：（1）远程主机收到用户的登录请求，把自己的公钥发给用户。（2）用户使用这个公钥，将登录密码加密后，发送回来。（3）远程主机用自己的私钥，解密登录密码，如果密码正确，就同意用户登录。</p> <h2 id="ssh-架构"><a href="#ssh-架构" class="header-anchor">#</a> SSH 架构</h2> <p>SSH 的软件架构是服务器-客户端模式（Server - Client）。在这个架构中，SSH 软件分成两个部分：向服务器发出请求的部分，称为客户端（client），OpenSSH 的实现为 ssh；接收客户端发出的请求的部分，称为服务器（server），OpenSSH 的实现为 sshd。</p> <h3 id="ssh-客户端-client"><a href="#ssh-客户端-client" class="header-anchor">#</a> SSH 客户端（Client）</h3> <p>penSSH 的客户端是二进制程序 ssh。它在 Linux/Unix 系统的位置是<code>/usr/local/bin/ssh</code>，Windows 系统的位置是<code>\Program Files\OpenSSH\bin\ssh.exe</code>。</p> <p>Linux 系统一般都自带 ssh，如果没有就需要安装。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># Ubuntu 和 Debian</span>
$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> openssh-client

<span class="token comment"># CentOS 和 Fedora</span>
$ <span class="token function">sudo</span> dnf <span class="token function">install</span> openssh-clients
</code></pre></div><p>安装以后，可以使用<code>-V</code>参数输出版本号，查看一下是否安装成功。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">ssh</span> -V
</code></pre></div><h3 id="ssh-服务端-server"><a href="#ssh-服务端-server" class="header-anchor">#</a> SSH 服务端（Server）</h3> <p>OpenSSH 的客户端软件是 ssh，服务器软件是 sshd。
如果没有安装 sshd，可以用下面的命令安装。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># Debian</span>
$ <span class="token function">sudo</span> <span class="token function">aptitude</span> <span class="token function">install</span> openssh-server

<span class="token comment"># Red Hat</span>
$ <span class="token function">sudo</span> yum <span class="token function">install</span> openssh-server
</code></pre></div><p>一般来说，sshd 安装后会跟着系统一起启动。如果当前 sshd 没有启动，可以用下面的命令启动。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ sshd
</code></pre></div><p>上面的命令运行后，如果提示“sshd re-exec requires execution with an absolute path”，就需要使用绝对路径来启动。这是为了防止有人出于各种目的，放置同名软件在<code>$PATH</code>变量指向的目录中，代替真正的 sshd。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># Centos、Ubuntu、OS X</span>
$ /usr/sbin/sshd
</code></pre></div><p>上面的命令运行以后，sshd 自动进入后台，所以命令后面不需要加上<code>&amp;</code>。</p> <p>除了直接运行可执行文件，也可以通过 Systemd 启动 sshd。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 启动</span>
$ <span class="token function">sudo</span> systemctl start sshd.service

<span class="token comment"># 停止</span>
$ <span class="token function">sudo</span> systemctl stop sshd.service

<span class="token comment"># 重启</span>
$ <span class="token function">sudo</span> systemctl restart sshd.service
</code></pre></div><p>下面的命令让 sshd 在计算机下次启动时自动运行。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> sshd.service
</code></pre></div><h2 id="ssh-用途"><a href="#ssh-用途" class="header-anchor">#</a> SSH 用途</h2> <ol><li>登录服务器</li> <li>SSH 隧道（tunnel）- 又称 端口转发</li></ol> <h3 id="_1-登录服务器"><a href="#_1-登录服务器" class="header-anchor">#</a> 1. 登录服务器</h3> <p>方式分为：密码登录、密钥登录、证书登录</p> <h4 id="_1-1-密码登录"><a href="#_1-1-密码登录" class="header-anchor">#</a> 1.1 密码登录</h4> <p>ssh 登录服务器的命令如下。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">ssh</span> <span class="token function">hostname</span>
</code></pre></div><p>上面命令中，<code>hostname</code>是主机名，它可以是域名，也可能是 IP 地址或局域网内部的主机名。不指定用户名的情况下，将使用客户端的当前用户名，作为远程服务器的登录用户名。如果要指定用户名，可以采用下面的语法。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">ssh</span> user@hostname
</code></pre></div><p>上面的命令中，用户名和主机名写在一起了，之间使用<code>@</code>分隔。</p> <p>用户名也可以使用<code>ssh</code>的<code>-l</code>参数指定，这样的话，用户名和主机名就不用写在一起了。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">ssh</span> -l username <span class="token function">host</span>
</code></pre></div><p>ssh 默认连接服务器的22端口，<code>-p</code>参数可以指定其他端口。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">ssh</span> -p <span class="token number">8821</span> foo.com
</code></pre></div><p>上面命令连接服务器<code>foo.com</code>的8821端口。</p> <h4 id="_1-2-密钥登录"><a href="#_1-2-密钥登录" class="header-anchor">#</a> 1.2 密钥登录</h4> <p>SSH 密钥登录分为以下的步骤。</p> <p>预备步骤，客户端通过<code>ssh-keygen</code>生成自己的公钥和私钥。</p> <p>第一步，手动将客户端的公钥放入远程服务器的指定位置(OpenSSH 规定，用户公钥保存在服务器的<code>~/.ssh/authorized_keys</code>文件)。</p> <p>第二步，客户端向服务器发起 SSH 登录的请求(<code>ssh remoteHost</code>)。</p> <p>第三步，服务器收到用户 SSH 登录的请求，发送一些随机数据给用户，要求用户证明自己的身份。</p> <p>第四步，客户端收到服务器发来的数据，使用私钥对数据进行签名，然后再发还给服务器。</p> <p>第五步，服务器收到客户端发来的加密签名后，使用对应的公钥解密，然后跟原始数据比较。如果一致，就允许用户登录。</p> <h4 id="_1-3-证书登录"><a href="#_1-3-证书登录" class="header-anchor">#</a> 1.3 证书登录</h4> <p>证书登录引入了一个证书颁发机构（Certificate Authority，简称 CA），对信任的服务器颁发服务器证书，对信任的用户颁发用户证书。
登录时，用户和服务器不需要提前知道彼此的公钥，只需要交换各自的证书，验证是否可信即可。</p> <p>证书登录的主要优点有两个：（1）用户和服务器不用交换公钥，这更容易管理，也具有更好的可扩展性。（2）证书可以设置到期时间，而公钥没有到期时间。针对不同的情况，可以设置有效期很短的证书，进一步提高安全性。</p> <p>SSH 证书登录之前，如果还没有证书，需要生成证书。具体方法是：（1）用户和服务器都将自己的公钥，发给 CA；（2）CA 使用服务器公钥，生成服务器证书，发给服务器；（3）CA 使用用户的公钥，生成用户证书，发给用户。</p> <p>有了证书以后，用户就可以登录服务器了。整个过程都是 SSH 自动处理，用户无感知。</p> <p>第一步，用户登录服务器时，SSH 自动将用户证书发给服务器。</p> <p>第二步，服务器检查用户证书是否有效，以及是否由可信的 CA 颁发。证实以后，就可以信任用户。</p> <p>第三步，SSH 自动将服务器证书发给用户。</p> <p>第四步，用户检查服务器证书是否有效，以及是否由信任的 CA 颁发。证实以后，就可以信任服务器。</p> <p>第五步，双方建立连接，服务器允许用户登录。</p> <h3 id="_2-ssh-隧道"><a href="#_2-ssh-隧道" class="header-anchor">#</a> 2. SSH 隧道</h3> <h4 id="_2-1-本地转发"><a href="#_2-1-本地转发" class="header-anchor">#</a> 2.1 本地转发</h4> <p>本地转发（local forwarding）指的是，SSH 服务器作为中介的跳板机，建立本地计算机与特定目标网站之间的加密连接。本地转发是在本地计算机的 SSH 客户端建立的转发规则。</p> <p>它会指定一个本地端口（local-port），所有发向那个端口的请求，都会转发到 SSH 跳板机（tunnel-host），然后 SSH 跳板机作为中介，将收到的请求发到目标服务器（target-host）的目标端口（target-port）。</p> <div class="language-html extra-class"><pre class="language-html"><code>$ ssh -L local-port:target-host:target-port tunnel-host
</code></pre></div><p>上面命令中，<code>-L</code>参数表示本地转发，<code>local-port</code>是本地端口，<code>target-host</code>是你想要访问的目标服务器，<code>target-port</code>是目标服务器的端口，<code>tunnel-host</code>是 SSH 跳板机。
如果经常使用本地转发，可以将设置写入 SSH 客户端的用户个人配置文件（<code>~/.ssh/config</code>）。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>Host test.example.com
LocalForward client-IP:client-port server-IP:server-port
</code></pre></div><h4 id="_2-2-远程转发"><a href="#_2-2-远程转发" class="header-anchor">#</a> 2.2 远程转发</h4> <p>程端口指的是在远程 SSH 服务器建立的转发规则。</p> <p>这种场景比较特殊，主要针对内网的情况。本地计算机在外网，SSH 跳板机和目标服务器都在内网，而且本地计算机无法访问内网之中的 SSH 跳板机，但是 SSH 跳板机可以访问本机计算机。</p> <p>由于本机无法访问内网 SSH 跳板机，就无法从外网发起 SSH 隧道，建立端口转发。必须反过来，从 SSH 跳板机发起隧道，建立端口转发，这时就形成了远程端口转发。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">ssh</span> -R local-port:target-host:target-port -N <span class="token builtin class-name">local</span>
</code></pre></div><p>上面的命令，首先需要注意，不是在本机执行的，而是在 SSH 跳板机执行的，从跳板机去连接本地计算机。<code>-R</code>参数表示远程端口转发，<code>local-port</code>是本地计算机的端口，<code>target-host</code>和<code>target-port</code>是目标服务器及其端口，<code>local</code>是本地计算机。</p> <p>显然，远程端口转发要求本地计算机也安装了 SSH 服务器，这样才能接受 SSH 跳板机的远程登录。</p> <h4 id="_2-3-动态转发"><a href="#_2-3-动态转发" class="header-anchor">#</a> 2.3 动态转发</h4> <p>动态转发指的是，本机与 SSH 服务器之间创建了一个加密连接，然后本机内部针对某个端口的通信，都通过这个加密连接转发。它的一个使用场景就是，访问所有外部网站，都通过 SSH 转发。</p> <p>动态转发需要把本地端口绑定到 SSH 服务器。至于 SSH 服务器要去访问哪一个网站，完全是动态的，取决于原始通信，所以叫做动态转发。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">ssh</span> -D local-port tunnel-host -N
</code></pre></div><p>上面命令中，<code>-D</code>表示动态转发，<code>local-port</code>是本地端口，<code>tunnel-host</code>是 SSH 服务器，<code>-N</code>表示这个 SSH 连接只进行端口转发，不登录远程 Shell，不能执行远程命令，只能充当隧道。</p> <h2 id="参考文档"><a href="#参考文档" class="header-anchor">#</a> 参考文档</h2></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#ssh-介绍" title="SSH 介绍">SSH 介绍</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#ssh-架构" title="SSH 架构">SSH 架构</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#ssh-客户端-client" title="SSH 客户端（Client）">SSH 客户端（Client）</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#ssh-服务端-server" title="SSH 服务端（Server）">SSH 服务端（Server）</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#ssh-用途" title="SSH 用途">SSH 用途</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_1-登录服务器" title="1. 登录服务器">1. 登录服务器</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-ssh-隧道" title="2. SSH 隧道">2. SSH 隧道</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#参考文档" title="参考文档">参考文档</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a5a1f001.js" defer></script><script src="/assets/js/6.e4377708.js" defer></script><script src="/assets/js/3.97575248.js" defer></script><script src="/assets/js/14.9188933b.js" defer></script>
  </body>
</html>
